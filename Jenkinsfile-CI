pipeline{

   agent any
 
   environment{
 
      DOCKERHUB_USERNAME = "madhaviraj"
      APP_NAME = "gitops-argo-app"
      IMAGE_TAG = "${BUILD_NUMBER}"
      IMAGE_NAME = "${DOCKERHUB_USERNAME}" + "/" + "${APP_NAME}"
      REGISTRY_CREDS = 'dockerhub'
      
   }

   stages{

      stage('Clean workspace'){

          steps{

              script{
              
                  cleanWs()
 
              }
           }

        }
   
      stage('git checkout'){

           steps{
 
              script{

                  git credentialsId: 'github',
                  url: 'https://github.com/madhavi33/argocdproject-CI.git',
                  branch: 'main'
                }
           }

        }
      
      stage('Build Docker Image'){
    
          steps{

             script{

                docker_image = docker.build "${IMAGE_NAME}"
             }
          }

       }

      stage('push docker image'){
        
        steps{
            script{

                 docker.withRegistry('',REGISTRY_CREDS){
                    docker_image.push("$BUILD_NUMBER")
                    docker_image.push('latest')
                  }
               }
           }
          }
   
      stage('delete docker images'){
 
          steps{

            script{

                sh "docker rmi ${IMAGE_NAME}:${IMAGE_TAG}"
                sh "docker rmi ${IMAGE_NAME}:latest"
            }
          }

        }


      stage('updating kubernetes deployment file'){

        steps{

            script{

                sh """
                 cat deployment.yml
                 sed -i 's/${APP_NAME}.*/${APP_NAME}:${IMAGE_TAG}/g' deployment.yml
                 cat deployment.yml

                """

              }
          }
        }

      stage('push the changed deployment file to git'){
 
          steps{

             script{

                sh """
                   git config --global user.name "madhavi33"
                   git config --global user.email "madhavi.v9@gmail.com"
                   git add deployment.yml
                   git commit -m "pushing deployment.yml"
                """
                withCredentials([gitUsernamePassword(credentialsId: 'github', gitToolName: 'Default')]) {
                      sh "git push https://github.com/madhavi33/argocdproject-CI.git main"

                       }
                  }
            }
          
        }




   }


}


